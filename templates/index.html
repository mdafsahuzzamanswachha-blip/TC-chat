<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TC Chat</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f2f2f2;display:flex;flex-direction:column;height:100vh;}
#chat{flex:1;overflow-y:auto;padding:10px;}
.message{margin:5px 0;padding:8px 12px;border-radius:15px;max-width:70%;word-wrap:break-word;}
.sent{background:#dcf8c6;margin-left:auto;}
.received{background:#fff;margin-right:auto;}
#inputContainer{display:flex;padding:10px;background:#eee;}
#msg{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;resize:none;}
button{margin-left:10px;padding:10px 15px;border:none;border-radius:10px;background:#25d366;color:#fff;cursor:pointer;}
#drawer{position:fixed;top:0;left:-250px;width:250px;height:100%;background:#075e54;color:#fff;padding:20px;transition:0.3s;box-sizing:border-box;}
#drawer.open{left:0;}
#toggleDrawer{position:absolute;top:10px;left:10px;padding:10px;background:#25d366;color:#fff;border:none;border-radius:5px;cursor:pointer;}
#callOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;flex-direction:column;z-index:200;}
#callOverlay video{width:45%;margin:10px;border-radius:10px;border:2px solid #fff;}
#bottomHangupBtn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:15px 30px;background:red;color:white;border:none;border-radius:10px;cursor:pointer;z-index:300;display:none;}
</style>
</head>
<body>

<!-- Side drawer -->
<div id="drawer">
<h3>Settings</h3>
<label>Nickname:</label>
<input type="text" id="nickname" placeholder="Enter nickname"/><br/><br/>
<label>Background Color:</label>
<input type="color" id="bgColor" value="#f2f2f2"/><br/><br/>
<label>Background Image:</label>
<input type="file" id="bgImage" accept="image/*"/>
<br/><br/>
<button onclick="startCall()">Start Call</button>
</div>

<button id="toggleDrawer">â˜°</button>

<!-- Chat display -->
<div id="chat"></div>

<!-- Message input -->
<div id="inputContainer">
<textarea id="msg" placeholder="Type a message..." rows="1"></textarea>
<input type="file" id="imgInput" accept="image/*"/>
<button onclick="sendMessage()">Send</button>
</div>

<!-- Call overlay -->
<div id="callOverlay">
<video id="localVideo" autoplay muted></video>
<video id="remoteVideo" autoplay></video>
</div>

<!-- Bottom Hang Up button -->
<button id="bottomHangupBtn">Hang Up</button>

<script>
var socket = io();
var nicknameInput = document.getElementById('nickname');
var drawer = document.getElementById('drawer');
var toggleDrawerBtn = document.getElementById('toggleDrawer');
var chat = document.getElementById('chat');
var msgInput = document.getElementById('msg');
var imgInput = document.getElementById('imgInput');

var callOverlay = document.getElementById('callOverlay');
var localVideo = document.getElementById('localVideo');
var remoteVideo = document.getElementById('remoteVideo');
var bottomHangupBtn = document.getElementById('bottomHangupBtn');

toggleDrawerBtn.onclick = ()=>drawer.classList.toggle('open');

// Nickname
nicknameInput.onchange = ()=>{
    socket.emit('set_nickname', nicknameInput.value || "Anonymous");
};

// Send message
function sendMessage(){
    var msg = msgInput.value;
    if(!msg && !imgInput.files[0]) return;
    if(imgInput.files[0]){
        var reader = new FileReader();
        reader.onload = function(e){
            socket.emit('message', JSON.stringify({msg: msg, image: e.target.result}));
        };
        reader.readAsDataURL(imgInput.files[0]);
    }else{
        socket.emit('message', JSON.stringify({msg: msg}));
    }
    msgInput.value='';
    imgInput.value='';
}

// Enter / Shift+Enter
msgInput.addEventListener("keydown", function(e){
    if(e.key==="Enter" && !e.shiftKey){e.preventDefault();sendMessage();}
});

// Receive messages
socket.on('message', function(data){
    var div = document.createElement('div');
    div.className = (data.nickname===nicknameInput.value) ? 'message sent':'message received';
    div.innerHTML = `<b>${data.nickname}:</b> ${data.msg}`;
    if(data.image) div.innerHTML += `<br/><img src="${data.image}" style="max-width:200px;border-radius:10px;margin-top:5px;">`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
});

// WebRTC
var pc;
var localStream;

async function startCall(){
    callOverlay.style.display="flex";
    bottomHangupBtn.style.display="block"; // show only when call starts

    pc = new RTCPeerConnection();
    pc.ontrack = e=>remoteVideo.srcObject=e.streams[0];

    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));

    pc.onicecandidate = e=>{ if(e.candidate) socket.emit("webrtc_ice_candidate", e.candidate); };

    var offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("webrtc_offer", offer);
}

// Hang Up
bottomHangupBtn.onclick = ()=>{
    callOverlay.style.display="none";
    bottomHangupBtn.style.display="none";

    if(pc){
        pc.getSenders().forEach(s=>pc.removeTrack(s));
        pc.close();
        pc = null;
    }
    if(localStream){
        localStream.getTracks().forEach(track=>track.stop());
        localStream = null;
    }
};

// WebRTC signaling
socket.on("webrtc_offer", async offer=>{
    if(!pc){pc = new RTCPeerConnection(); callOverlay.style.display="flex"; bottomHangupBtn.style.display="block";}
    pc.ontrack = e=>remoteVideo.srcObject=e.streams[0];

    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));

    pc.onicecandidate = e=>{ if(e.candidate) socket.emit("webrtc_ice_candidate", e.candidate); };

    await pc.setRemoteDescription(offer);
    var answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("webrtc_answer", answer);
});

socket.on("webrtc_answer", async answer=>{ if(pc) await pc.setRemoteDescription(answer); });
socket.on("webrtc_ice_candidate", async candidate=>{ if(pc) await pc.addIceCandidate(candidate); });

// Background change
document.getElementById('bgColor').onchange = e=>{ document.body.style.background = e.target.value; };
document.getElementById('bgImage').onchange = e=>{
    var reader = new FileReader();
    reader.onload = function(ev){
        document.body.style.backgroundImage = `url(${ev.target.result})`;
        document.body.style.backgroundSize = "cover";
    };
    reader.readAsDataURL(e.target.files[0]);
};
</script>
</body>
</html>
